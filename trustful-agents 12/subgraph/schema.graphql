# =============================================================================
# Trustful Agents - Subgraph Schema
# =============================================================================

# -----------------------------------------------------------------------------
# Agent Entity - Core identity with trust info
# -----------------------------------------------------------------------------
type Agent @entity {
  id: ID!                           # ERC-8004 token ID (hex)
  owner: Bytes!                     # Current owner address
  
  # Collateral
  collateralBalance: BigInt!        # Total USDC deposited
  lockedCollateral: BigInt!         # Amount locked by claims
  availableCollateral: BigInt!      # Unlocked balance
  
  # Withdrawal
  withdrawalPending: Boolean!
  withdrawalAmount: BigInt
  withdrawalExecuteAfter: BigInt
  
  # Terms
  activeTermsVersion: Int
  activeTermsHash: Bytes
  activeTermsUri: String
  maxPayoutPerClaim: BigInt
  councilId: Bytes
  
  # Validation
  isValidated: Boolean!
  validationRequestHash: Bytes
  validationIssuedAt: BigInt
  validationRevokedAt: BigInt
  revocationReason: String
  
  # Statistics
  totalClaims: Int!
  approvedClaims: Int!
  rejectedClaims: Int!
  pendingClaims: Int!
  totalPaidOut: BigInt!
  
  # Relations
  termsVersions: [TermsVersion!]! @derivedFrom(field: "agent")
  claims: [Claim!]! @derivedFrom(field: "agent")
  deposits: [Deposit!]! @derivedFrom(field: "agent")
  
  # Timestamps
  createdAt: BigInt!
  updatedAt: BigInt!
}

# -----------------------------------------------------------------------------
# Terms Version - T&C history per agent
# -----------------------------------------------------------------------------
type TermsVersion @entity {
  id: ID!                           # agentId-version
  agent: Agent!
  version: Int!
  
  contentHash: Bytes!
  contentUri: String!
  maxPayoutPerClaim: BigInt!
  councilId: Bytes!
  
  isActive: Boolean!
  registeredAt: BigInt!
  deactivatedAt: BigInt
}

# -----------------------------------------------------------------------------
# Council - Dispute resolution body
# -----------------------------------------------------------------------------
type Council @entity {
  id: ID!                           # councilId (bytes32 hex)
  name: String!
  vertical: String!
  
  memberCount: Int!
  quorumPercentage: Int!            # Basis points
  claimDepositPercentage: Int!      # Basis points
  votingPeriod: BigInt!             # Seconds
  evidencePeriod: BigInt!           # Seconds
  
  isActive: Boolean!
  
  # Statistics
  totalClaims: Int!
  approvedClaims: Int!
  rejectedClaims: Int!
  totalCompensationPaid: BigInt!
  totalDepositsForfeited: BigInt!
  
  # Relations
  members: [CouncilMember!]! @derivedFrom(field: "council")
  claims: [Claim!]! @derivedFrom(field: "council")
  
  createdAt: BigInt!
  updatedAt: BigInt!
}

# -----------------------------------------------------------------------------
# Council Member
# -----------------------------------------------------------------------------
type CouncilMember @entity {
  id: ID!                           # councilId-memberAddress
  council: Council!
  member: Bytes!
  
  isActive: Boolean!
  joinedAt: BigInt!
  leftAt: BigInt
  
  # Statistics
  claimsVoted: Int!
  approveVotes: Int!
  rejectVotes: Int!
  abstainVotes: Int!
  
  votes: [Vote!]! @derivedFrom(field: "voter")
}

# -----------------------------------------------------------------------------
# Claim - Dispute filed against an agent
# -----------------------------------------------------------------------------
type Claim @entity {
  id: ID!                           # claimId (numeric)
  agent: Agent!
  council: Council!
  
  claimant: Bytes!
  claimedAmount: BigInt!
  approvedAmount: BigInt
  
  # Evidence
  evidenceHash: Bytes!
  evidenceUri: String!
  paymentReceiptHash: Bytes!
  additionalEvidence: [Evidence!]! @derivedFrom(field: "claim")
  
  # Snapshot at claim time
  termsHashAtClaimTime: Bytes!
  termsVersionAtClaimTime: Int!
  providerAtClaimTime: Bytes!
  
  # Deposits & Locking
  claimantDeposit: BigInt!
  lockedCollateral: BigInt!
  
  # Status
  status: ClaimStatus!
  
  # Timeline
  filedAt: BigInt!
  evidenceDeadline: BigInt!
  votingDeadline: BigInt!
  closedAt: BigInt
  executedAt: BigInt
  
  # Voting
  votes: [Vote!]! @derivedFrom(field: "claim")
  approveVotes: Int!
  rejectVotes: Int!
  abstainVotes: Int!
  totalVotes: Int!
}

enum ClaimStatus {
  Filed
  EvidenceClosed
  VotingClosed
  Approved
  Rejected
  Executed
  Cancelled
}

# -----------------------------------------------------------------------------
# Evidence - Additional evidence for claims
# -----------------------------------------------------------------------------
type Evidence @entity {
  id: ID!                           # claimId-index
  claim: Claim!
  
  submitter: Bytes!
  isCounterEvidence: Boolean!
  evidenceHash: Bytes!
  evidenceUri: String!
  
  submittedAt: BigInt!
}

# -----------------------------------------------------------------------------
# Vote - Council member vote on claim
# -----------------------------------------------------------------------------
type Vote @entity {
  id: ID!                           # claimId-voterAddress
  claim: Claim!
  voter: CouncilMember!
  
  vote: VoteType!
  approvedAmount: BigInt
  reasoning: String
  
  votedAt: BigInt!
}

enum VoteType {
  Approve
  Reject
  Abstain
}

# -----------------------------------------------------------------------------
# Deposit - Collateral deposit event
# -----------------------------------------------------------------------------
type Deposit @entity {
  id: ID!                           # txHash-logIndex
  agent: Agent!
  
  depositor: Bytes!
  amount: BigInt!
  
  timestamp: BigInt!
  transactionHash: Bytes!
}

# -----------------------------------------------------------------------------
# Withdrawal - Withdrawal event
# -----------------------------------------------------------------------------
type Withdrawal @entity {
  id: ID!                           # txHash-logIndex
  agent: Agent!
  
  recipient: Bytes!
  amount: BigInt!
  
  initiatedAt: BigInt!
  executedAt: BigInt
  cancelledAt: BigInt
  
  transactionHash: Bytes!
}

# -----------------------------------------------------------------------------
# Validation Event - Track validation changes
# -----------------------------------------------------------------------------
type ValidationEvent @entity {
  id: ID!                           # txHash-logIndex
  agent: Agent!
  
  eventType: ValidationEventType!
  requestHash: Bytes
  reason: String
  
  timestamp: BigInt!
  transactionHash: Bytes!
}

enum ValidationEventType {
  Issued
  Revoked
}

# -----------------------------------------------------------------------------
# Protocol Statistics - Aggregate metrics
# -----------------------------------------------------------------------------
type ProtocolStats @entity {
  id: ID!                           # "global"
  
  totalAgents: Int!
  validatedAgents: Int!
  totalCollateral: BigInt!
  lockedCollateral: BigInt!
  
  totalCouncils: Int!
  activeCouncils: Int!
  totalCouncilMembers: Int!
  
  totalClaims: Int!
  pendingClaims: Int!
  approvedClaims: Int!
  rejectedClaims: Int!
  
  totalCompensationPaid: BigInt!
  totalDepositsForfeited: BigInt!
  
  updatedAt: BigInt!
}
